{% extends "rest_framework/base.html" %}
{% comment %} 
  This template extends the DRF base template with some javascript.

  Because DSOPaginator calculates page count during streaming, 
  we setup the pagination links client-side after the page is loaded.
 
  The page data is not included in the template, instead we load the data in a separate ajax call.
  This improves responsiveness and makes rendering more efficient removing a
  potential DOS-attackvector for large datasets.
{% endcomment %}

{% load i18n rest_framework static %}
{% block title %} {% if name %}{{ name }} – {% endif %} Amsterdam Datadiensten {% endblock %}
{% block branding %}
       <div>
            <a class='navbar-brand' rel="nofollow" href="https://api.data.amsterdam.nl">
                <svg viewBox="0 0 100 68" xmlns="http://www.w3.org/2000/svg" focusable="false" class="AmsterdamLogoStyle__LogoTallStyle-sc-1yuessa-1 dZhyXZ"><path d="M39.477 10.739a7.271 7.271 0 01-1.556.528 9.017 9.017 0 01-1.95.189c-.754 0-1.441-.12-2.063-.359a4.72 4.72 0 01-1.602-1.003 4.55 4.55 0 01-1.044-1.538 5.056 5.056 0 01-.375-1.974c0-.739.13-1.405.388-2a4.454 4.454 0 011.064-1.519 4.73 4.73 0 011.595-.964 5.73 5.73 0 011.997-.339c.744 0 1.425.107 2.042.32.617.212 1.114.493 1.49.84l-1.142 1.225c-.236-.26-.567-.482-.991-.665a3.473 3.473 0 00-1.386-.273 3.3 3.3 0 00-1.333.26 2.99 2.99 0 00-1.018.717 3.23 3.23 0 00-.65 1.069c-.153.408-.23.851-.23 1.329 0 .495.077.949.23 1.362.153.412.372.77.657 1.075.284.304.63.54 1.037.71.407.17.87.254 1.386.254.709 0 1.326-.109 1.852-.326V7.312h-1.957V5.956h3.559v4.783zm7.946-2.567v.208c0 .07-.004.14-.013.209h-4.794a1.54 1.54 0 00.578 1.1c.166.135.355.242.565.32.21.078.429.117.657.117.394 0 .726-.071.998-.215.271-.143.494-.34.67-.593l1.05.834c-.621.834-1.523 1.251-2.705 1.251-.49 0-.942-.076-1.353-.228a3.197 3.197 0 01-1.07-.645 2.907 2.907 0 01-.71-1.023 3.502 3.502 0 01-.256-1.374c0-.504.085-.963.256-1.375.171-.413.405-.765.703-1.056.298-.29.65-.517 1.057-.677a3.556 3.556 0 011.32-.241c.438 0 .843.071 1.215.215.372.143.694.356.965.638.272.282.484.634.637 1.056.154.421.23.914.23 1.479zm-1.576-.704c0-.2-.028-.391-.085-.573a1.31 1.31 0 00-.27-.483 1.314 1.314 0 00-.466-.332 1.641 1.641 0 00-.663-.124c-.473 0-.873.142-1.202.424a1.54 1.54 0 00-.545 1.088h3.231zm10.626-2.684c.411 0 .764.071 1.057.215.293.143.534.332.722.566.189.235.327.504.414.808.088.304.132.617.132.939v3.909H57.22V7.755c0-.183-.013-.374-.039-.574-.026-.2-.083-.38-.17-.54a1.127 1.127 0 00-.362-.398c-.153-.104-.357-.156-.61-.156a1.21 1.21 0 00-.631.156c-.175.104-.32.239-.433.404-.114.165-.197.35-.25.554a2.424 2.424 0 00-.079.606v3.414H53.07v-3.78c0-.39-.094-.714-.282-.97-.189-.256-.484-.384-.887-.384a1.225 1.225 0 00-1.044.534c-.11.156-.193.337-.25.54a2.34 2.34 0 00-.085.62v3.44h-1.576V4.966h1.497v1.003h.027c.07-.156.164-.304.282-.443a2.19 2.19 0 01.42-.378c.162-.113.348-.202.558-.267.21-.065.443-.097.697-.097.49 0 .897.108 1.221.325.324.218.573.504.749.86.21-.382.49-.675.84-.88.35-.203.762-.305 1.235-.305zm10.179 3.388v.208c0 .07-.005.14-.013.209h-4.794a1.54 1.54 0 00.578 1.1c.166.135.354.242.564.32.21.078.43.117.657.117.394 0 .727-.071.998-.215.272-.143.495-.34.67-.593l1.05.834c-.62.834-1.523 1.251-2.705 1.251-.49 0-.941-.076-1.353-.228a3.197 3.197 0 01-1.07-.645 2.907 2.907 0 01-.71-1.023 3.502 3.502 0 01-.255-1.374c0-.504.085-.963.256-1.375.17-.413.405-.765.702-1.056.298-.29.65-.517 1.058-.677a3.556 3.556 0 011.32-.241c.438 0 .843.071 1.215.215.372.143.694.356.965.638.271.282.484.634.637 1.056.153.421.23.914.23 1.479zm-1.576-.704c0-.2-.029-.391-.086-.573a1.31 1.31 0 00-.269-.483 1.314 1.314 0 00-.466-.332 1.641 1.641 0 00-.663-.124c-.473 0-.874.142-1.202.424a1.54 1.54 0 00-.545 1.088h3.23zm9.115.704v.208c0 .07-.004.14-.013.209h-4.794a1.54 1.54 0 00.578 1.1 1.971 1.971 0 001.221.437c.394 0 .727-.071.998-.215.272-.143.495-.34.67-.593l1.051.834c-.622.834-1.524 1.251-2.706 1.251-.49 0-.94-.076-1.352-.228a3.197 3.197 0 01-1.07-.645 2.907 2.907 0 01-.71-1.023 3.502 3.502 0 01-.256-1.374c0-.504.085-.963.256-1.375.17-.413.405-.765.703-1.056.297-.29.65-.517 1.057-.677a3.556 3.556 0 011.32-.241c.438 0 .843.071 1.215.215.372.143.694.356.965.638.272.282.484.634.637 1.056.153.421.23.914.23 1.479zm-1.576-.704c0-.2-.029-.391-.085-.573a1.31 1.31 0 00-.27-.483 1.314 1.314 0 00-.466-.332 1.641 1.641 0 00-.663-.124c-.473 0-.874.142-1.202.424a1.54 1.54 0 00-.545 1.088h3.23zm3.1-2.502h1.497v1.003h.026c.14-.312.383-.588.73-.827.345-.239.754-.358 1.227-.358.412 0 .764.071 1.057.215.294.143.535.332.723.566.188.235.326.504.414.808.087.304.13.617.13.939v3.909h-1.575V7.755c0-.183-.013-.374-.04-.574-.026-.2-.083-.38-.17-.54a1.127 1.127 0 00-.362-.398c-.153-.104-.356-.156-.61-.156s-.473.05-.657.15c-.184.1-.335.228-.453.384a1.697 1.697 0 00-.27.54c-.06.205-.091.411-.091.62v3.44h-1.576V4.966zm6.738 1.251V4.966h1.103V3.155h1.55v1.811h1.576v1.251h-1.576v2.906c0 .278.05.508.15.69.101.183.327.274.677.274.105 0 .219-.01.342-.032a1.42 1.42 0 00.328-.098l.052 1.225c-.14.052-.306.093-.499.124-.192.03-.376.045-.551.045-.42 0-.762-.058-1.025-.176a1.551 1.551 0 01-.624-.482 1.778 1.778 0 01-.315-.703 4.06 4.06 0 01-.085-.854V6.217h-1.103zM93.84 8.172v.208c0 .07-.004.14-.013.209h-4.794a1.54 1.54 0 00.578 1.1 1.971 1.971 0 001.221.437c.394 0 .727-.071.998-.215.272-.143.495-.34.67-.593l1.051.834c-.622.834-1.524 1.251-2.706 1.251-.49 0-.94-.076-1.352-.228a3.197 3.197 0 01-1.07-.645 2.907 2.907 0 01-.71-1.023 3.502 3.502 0 01-.256-1.374c0-.504.085-.963.256-1.375.17-.413.405-.765.703-1.056.297-.29.65-.517 1.057-.677a3.556 3.556 0 011.32-.241c.438 0 .843.071 1.215.215.372.143.694.356.965.638.272.282.484.634.637 1.056.153.421.23.914.23 1.479zm-1.576-.704c0-.2-.029-.391-.085-.573a1.31 1.31 0 00-.27-.483 1.314 1.314 0 00-.466-.332 1.641 1.641 0 00-.663-.124c-.473 0-.874.142-1.202.424a1.54 1.54 0 00-.545 1.088h3.23zM36.35 20.734l-1.43-3.754-1.457 3.753h2.89zm-2.101-5.708h1.431l4.006 9.226h-1.891l-.867-2.11h-4.032l-.84 2.11h-1.853l4.046-9.226zm13.804 2.789c.411 0 .764.072 1.057.215.293.143.534.332.722.567.189.234.327.504.414.808.088.304.131.617.131.938v3.91h-1.576v-3.467c0-.182-.013-.374-.039-.573-.026-.2-.083-.38-.17-.541a1.127 1.127 0 00-.362-.398c-.153-.104-.357-.156-.61-.156a1.21 1.21 0 00-.631.156c-.175.105-.32.24-.434.404-.113.165-.197.35-.25.554a2.424 2.424 0 00-.078.606v3.414h-1.576v-3.779c0-.39-.094-.714-.282-.97-.189-.257-.484-.385-.887-.385a1.225 1.225 0 00-1.044.534c-.11.157-.193.337-.25.541a2.29 2.29 0 00-.085.62v3.44h-1.576v-6.256h1.497v1.004h.026c.07-.157.165-.304.283-.443.118-.14.258-.265.42-.378.162-.113.348-.202.558-.267.21-.066.442-.098.696-.098.49 0 .898.108 1.222.326.324.217.573.504.749.86.21-.383.49-.676.84-.88.35-.204.762-.306 1.235-.306zm7.618 1.85a1.816 1.816 0 00-.578-.475 1.637 1.637 0 00-.801-.202c-.254 0-.486.052-.697.156a.538.538 0 00-.315.521c0 .244.116.415.348.515.232.1.572.202 1.018.306.237.052.475.122.716.209.24.087.46.202.657.345.197.143.356.322.48.534.122.213.183.472.183.776 0 .382-.072.706-.217.97-.144.266-.337.48-.578.646-.24.165-.52.284-.84.358-.32.074-.65.11-.992.11-.49 0-.967-.088-1.431-.266a3.028 3.028 0 01-1.156-.763l1.037-.964a2.06 2.06 0 001.616.782c.114 0 .23-.013.348-.04.118-.025.228-.067.328-.123a.678.678 0 00.243-.228.639.639 0 00.092-.352c0-.26-.12-.447-.361-.56-.24-.113-.602-.226-1.084-.34a5.241 5.241 0 01-.69-.201 2.256 2.256 0 01-.597-.326 1.512 1.512 0 01-.42-.502c-.105-.2-.158-.447-.158-.742 0-.348.073-.648.217-.9a1.86 1.86 0 01.571-.618c.237-.161.504-.28.802-.359.297-.078.604-.117.919-.117.455 0 .9.078 1.333.234a2.25 2.25 0 011.031.717l-1.024.9zm1.47-.417v-1.25h1.104v-1.812h1.55v1.811h1.576v1.251h-1.576v2.906c0 .278.05.509.15.691.102.182.327.274.677.274.105 0 .22-.011.342-.033.122-.022.232-.054.328-.098l.053 1.225c-.14.052-.307.094-.5.124a3.58 3.58 0 01-.551.046c-.42 0-.762-.059-1.024-.176a1.551 1.551 0 01-.624-.482 1.778 1.778 0 01-.316-.704 4.06 4.06 0 01-.085-.854v-2.919h-1.103zm11.388 1.955v.209c0 .069-.004.139-.013.208h-4.794a1.54 1.54 0 00.578 1.101c.166.135.355.241.565.32.21.078.429.117.656.117.394 0 .727-.072.999-.215.271-.144.494-.341.67-.593l1.05.834c-.621.834-1.523 1.25-2.705 1.25-.49 0-.942-.075-1.353-.227a3.197 3.197 0 01-1.07-.645 2.907 2.907 0 01-.71-1.023 3.502 3.502 0 01-.256-1.375c0-.504.085-.962.256-1.375.17-.413.405-.764.703-1.055.298-.291.65-.517 1.057-.678.407-.16.847-.241 1.32-.241.438 0 .843.072 1.215.215.372.143.694.356.965.638.272.283.484.635.637 1.056.154.421.23.914.23 1.479zm-1.576-.704c0-.2-.028-.39-.085-.573a1.31 1.31 0 00-.27-.482 1.314 1.314 0 00-.466-.333 1.641 1.641 0 00-.663-.123c-.473 0-.873.14-1.202.423a1.54 1.54 0 00-.545 1.088h3.231zm3.1-2.502h1.51v1.043h.027c.175-.365.42-.66.735-.886a1.845 1.845 0 011.103-.34c.062 0 .127.003.197.007.07.005.132.016.184.033v1.433a1.87 1.87 0 00-.486-.065c-.359 0-.648.065-.867.196-.218.13-.39.286-.512.469-.122.182-.206.37-.25.56a2.164 2.164 0 00-.065.456v3.35h-1.576v-6.256zM75.82 21.1c0 .243.037.486.112.73.074.243.186.46.334.651.15.191.338.348.565.47.228.12.495.182.801.182.29 0 .548-.059.775-.176.228-.118.423-.272.585-.463.162-.191.284-.406.368-.645a2.186 2.186 0 000-1.453 1.982 1.982 0 00-.952-1.12 1.619 1.619 0 00-.776-.183c-.306 0-.573.059-.8.176a1.68 1.68 0 00-.566.462c-.148.192-.26.407-.334.646-.075.238-.112.48-.112.723zm5.188 3.153H79.51v-.938h-.027a2.139 2.139 0 01-.913.834 2.81 2.81 0 01-1.254.287 3.02 3.02 0 01-1.294-.267 2.969 2.969 0 01-.971-.717 3.174 3.174 0 01-.618-1.056 3.822 3.822 0 01-.216-1.296c0-.46.074-.89.223-1.29.149-.4.359-.747.63-1.043a2.945 2.945 0 012.207-.951 2.8 2.8 0 011.373.339 2.366 2.366 0 01.741.638h.04v-4.391h1.576v9.851zm5.805-2.854h-.354c-.254 0-.521.011-.802.033-.28.022-.538.07-.774.143a1.658 1.658 0 00-.592.313.693.693 0 00-.236.554.662.662 0 00.355.612c.105.061.223.105.354.13.132.027.263.04.394.04.543 0 .955-.143 1.235-.43.28-.287.42-.678.42-1.173v-.222zm.027 2.06h-.04c-.158.277-.411.505-.762.684a2.6 2.6 0 01-1.195.267c-.254 0-.519-.033-.794-.098a2.375 2.375 0 01-.762-.326 1.9 1.9 0 01-.578-.6c-.153-.247-.23-.553-.23-.918 0-.47.134-.843.4-1.12a2.604 2.604 0 011.032-.64 5.84 5.84 0 011.398-.292 16.19 16.19 0 011.504-.072v-.156c0-.391-.142-.68-.427-.867-.284-.187-.623-.28-1.018-.28-.332 0-.652.07-.958.208-.307.14-.56.309-.762.509l-.814-.952c.359-.33.772-.577 1.24-.743a4.26 4.26 0 011.426-.247c.56 0 1.022.078 1.385.234.364.157.65.361.86.613.21.252.358.534.44.847.084.313.126.625.126.938v3.805H86.84v-.795zm10.835-5.643c.412 0 .764.072 1.058.215.293.143.534.332.722.567.188.234.326.504.414.808.087.304.131.617.131.938v3.91h-1.576v-3.467c0-.182-.013-.374-.04-.573-.026-.2-.083-.38-.17-.541a1.127 1.127 0 00-.361-.398c-.154-.104-.357-.156-.611-.156a1.21 1.21 0 00-.63.156c-.176.105-.32.24-.434.404-.114.165-.197.35-.25.554a2.424 2.424 0 00-.078.606v3.414h-1.576v-3.779c0-.39-.095-.714-.283-.97-.188-.257-.484-.385-.886-.385a1.225 1.225 0 00-1.045.534 1.805 1.805 0 00-.25.541c-.056.204-.084.41-.084.62v3.44h-1.577v-6.256h1.498v1.004h.026c.07-.157.164-.304.282-.443.119-.14.259-.265.42-.378.163-.113.349-.202.559-.267.21-.066.442-.098.696-.098.49 0 .897.108 1.221.326.324.217.574.504.75.86.21-.383.49-.676.84-.88.35-.204.761-.306 1.234-.306zM0 64.002l5.926-5.997L0 52.008l3.95-3.997 5.926 5.996 5.926-5.996 3.95 3.997-5.926 5.997 5.926 5.997L15.802 68l-5.926-5.997L3.95 68 0 64.002zm0-48.01l5.926-5.997L0 3.998 3.95 0l5.926 5.997L15.802 0l3.95 3.998-5.926 5.997 5.926 5.997-3.95 3.997-5.926-5.996-5.926 5.996L0 15.992zm0 24.025l5.926-5.997L0 28.023l3.95-3.998 5.926 5.997 5.926-5.997 3.95 3.998-5.926 5.997 5.926 5.997-3.95 3.998-5.926-5.997-5.926 5.997L0 40.017z" fill="#EC0000"></path></svg>
                <span>Amsterdam datadiensten</span>
            </a>
       </div>
{% endblock %}

{% block style %}
    <link rel="stylesheet" type="text/css" href="{% static "rest_framework/css/bootstrap.min.css" %}"/>
    <link rel="stylesheet" type="text/css" href="{% static "rest_framework/css/bootstrap-tweaks.css" %}"/>
    <link rel="stylesheet" type="text/css" href="{% static "rest_framework/css/default.css" %}"/>
    <link rel="stylesheet" href="https://static.amsterdam.nl/fonts/fonts.css">
    <style>
        .navbar svg {
            height: 70px;
            margin-top: -15px;
            margin-right: 40px;
            vertical-align: middle;
        }
        body {
            background: white;
            overflow-y: scroll;
        }
        body a {
            color: #A30000
        }
        body a:hover {
            color: #c20000;
        }
        ul.breadcrumb {
            margin: 100px 0 0 0;
        }
        .breadcrumb li.active a {
            color: #777;
        }
        h1 {
            font-size: 30px;
        }
        .navbar {
            background-color: white;
            border-top: none;
            height: 100px;
            padding: 15px 0px;
            width: 100%;
            position: fixed;
            left: 0;
            top: 0;
            margin: 0px;
        }
        .navbar-brand {
            line-height: 38px;
            font-size: 30px;
            font-weight: 700;
            font-family: Avenir Next, Arial, sans-serif;
            font-stretch: normal;
            letter-spacing: normal;
            line-height: 38px;
            color: black;
        }
        .navbar-brand:hover {
            color: black;
        }
        .string { color: black; }
        .bool { color: darkcyan; }
        .number { color: #195f91 }
        .null { color: magenta; }
        .key { 
          color:  #EC0000; 
          font-weight: 550;
        }
        .link { color: #A30000; }
        .lit { color: #195f91; }
        .collapsible {
            cursor:pointer
        }
        .collapsible:not(.collapsed) .collapsible_summary {
            display: none
        }
        .collapsible:hover .collapsible_summary {
          background: #e4e4e4
        }
        .collapsible.collapsed .collapsible_content {
            display: none
        }
        .collapsible:not(.collapsed) .collapsible_content {
            display: inline-block;
            vertical-align: top;
        }
        nav {
          float: right;
          visibility: hidden;
          height: 0;
        }
        nav.active {
          visibility: initial;
          height:63px
        }
        nav ul {
          margin: 0;
        }
        #page-links .hidden {
          display: none;
        }
        input:invalid {
          color: darkred;
          font-style: italic;
        }
        .remove-param-btn {
          padding: 3px 6px;
        }
        .param:last-child .remove-param-btn, .param:last-child .param-check {
          visibility:hidden;
          pointer-events: none;
        }
        .param.loading, .param.disabled .param-key, .param.disabled .param-op,  .param.disabled .param-val {
          pointer-events: none;
          opacity: .6;
        }
        .param input, .param select {
          margin-right: 5px;
        }
        .param {
          margin-bottom: 5px;
          position: relative;
        }
        .param-op {
          height: 1.85em;
          width: 6em;
        }
        .param-key, .param-val {
          width: calc(50% - 0.925em - 54px);
        }
        .request-form-tabs {
          width: 100%;
          display: inline-block;
        }
        .request-settings {
          border-top-right-radius: 0;
          border-top-left-radius: 0;
          border-top: none;
        }
        .request-form-tab {
          padding: 6px 12px;
          line-height: 1.42857143;
          text-decoration: none;
          background-color: #f5f5f5;
          width: 50%;
          display: inline-block;
          border: 1px solid #ccc;
          border-bottom: 1px dotted #ddd;
        }
        .show-params .request-form-tab.headers-tab,.show-headers .request-form-tab.params-tab {
          padding: 6px 12px;
          color: #337ab7;
          background-color: #fff;
          border: 1px solid #ddd;
          cursor: pointer;
        }
        .request-form-tab:last-child {
          border-top-right-radius: 4px;
        }
        .request-form-tab:first-child {
          border-right: 0 !important;
          border-top-left-radius: 4px;
        }
        .show-params #request-headers, .show-headers #request-params {
          display:none;
        }
        #page-container {
          width: 100%;
          text-align: right;
          /* margin-top: 20px;
          margin-bottom: 5px; */
        }
        .button-form {
          margin-bottom: 10px;
        }
        #authorize-btn {
          float: right;
          background-color: green;
        }
        .param-info {
          visibility: collapse;
          position: absolute;
          float: right;
          top: 7px;
          right: 55px;
          height: 1.85em;
          display: block;
          max-width: 50%;
          z-index: 100;
          width: fit-content;
                  }

        .param-info::before {
          content: "?";
          position: absolute;
          color: green;
          right: -22px;
          border: 1px solid black;
          border-radius: 1em;
          height: 1.6em;
          width: 1.6em;
          padding: 0.1em;
            padding-left: 0.1em;
          padding-left: 0.1em;
          background: white;
          padding-left: 0.4em;
          font-weight: bold;
          cursor: pointer;
          visibility: visible;
          bottom: 5px;
        }

        .param-info .summary {
          width: fit-content;
          background: white;
          display: ruby;
          position: absolute;
          right: -23px;
          padding: 2px;
            padding-right: 2px;
            padding-left: 2px;
          top: -3px;
          padding-right: 20px;
          padding-left: 15px;
          z-index: -1;
          visibility: visible;
          font-style: italic;
          opacity:1;
          transition:visibility 1s linear,opacity .3s linear;
          max-width: 100%;
          overflow: hidden;
        }
        .param-info:hover, .param-info.expand {
          visibility: visible;
        }
        .param:hover .param-info .summary{
          visibility: hidden;
          opacity:0;
          transition:visibility 1s linear,opacity .3s linear;
        }
        .param-info.expand .summary {
          visibility: visible;
        }
        .param:hover .param-info:hover div.summary, .param-info.expand pre {
          border-color: black;
          visibility: visible !important;
          opacity: 1 !important;
        }
        .param-info pre {
          position: relative;
          top: 20px;
        }
        .param-info.hidden {
          visibility: hidden;
        }
    </style>
{% endblock %}

{% block content %}

<div class="content-main" role="main"  aria-label="{% trans "main content" %}">
  <btn id="authorize-btn" class="btn btn-primary disabled" onclick="authorize()">Authorize</btn>
  <div class="page-header">
    <h1>{{ name }}</h1>
    <h5>Bronhouder: {{ authorization_grantor|default_if_none:"Onbekend"}}</h5>
  </div>
  <div style="float:left">
    {% block description %}{{ block.super }}{% endblock %}
  </div> 
    <div class="region"  aria-label="{% trans "request form" %}">
    {% comment %} 
      Add an id to the options button so we can override its behaviour.
      Delete form is removed, as we do not expose this method.
    {% endcomment %}
    <div id="request-settings-container" class="show-params">
    <div class="request-form-tabs">
      <div id="params-tab" class="request-form-tab params-tab" onclick="event.target.parentElement.parentElement.className='show-params'">Parameters</div><div class="request-form-tab headers-tab" onclick="event.target.parentElement.parentElement.className='show-headers'" id="headers-tab">Headers</div>
    </div>
    <pre style="box-sizing: border-box;clear:both;" id="request-params" class="request-settings"></pre>
    <pre style="box-sizing: border-box;clear:both;overflow:visible;" id="request-headers" class="request-settings"></pre>
    <div>
    {% block request_forms %}
  
    {% if 'GET' in allowed_methods %}
      <form id="get-form" class="pull-right">
        <fieldset>
          {% if api_settings.URL_FORMAT_OVERRIDE %}
            <div class="btn-group format-selection">
              <a id="get-button" class="btn btn-primary js-tooltip" href="{{ request.get_full_path }}" rel="nofollow" title="Make a GET request on the {{ name }} resource">GET</a>

              <button class="btn btn-primary dropdown-toggle js-tooltip" data-toggle="dropdown" title="Specify a format for the GET request">
                <span class="caret"></span>
              </button>
              <ul class="dropdown-menu">
                {% for format in available_formats %}
                  <li>
                    <a class="js-tooltip format-option" href="{% add_query_param request api_settings.URL_FORMAT_OVERRIDE format %}" rel="nofollow" title="Make a GET request on the {{ name }} resource with the format set to `{{ format }}`">{{ format }}</a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <a id="get-button" class="btn btn-primary js-tooltip" href="{{ request.get_full_path }}" rel="nofollow" title="Make a GET request on the {{ name }} resource">GET</a>
          {% endif %}
        </fieldset>
      </form>
    {% endif %}

    {% if options_form %}
      <form class="button-form">
        <button id="options-button" class="btn btn-primary js-tooltip" title="Make an OPTIONS request on the {{ name }} resource">OPTIONS</button>
      </form>
    {% endif %}

    {% if extra_actions %}
      <div class="dropdown" style="float: right; margin-right: 10px">
        <button class="btn btn-default" id="extra-actions-menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
          {% trans "Extra Actions" %}
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" aria-labelledby="extra-actions-menu">
          {% for action_name, url in extra_actions|items %}
          <li><a href="{{ url }}">{{ action_name }}</a></li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if filter_form %}
      <button style="float: right; margin-right: 10px" data-toggle="modal" data-target="#filtersModal" class="btn btn-default">
        <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
        {% trans "Filters" %}
      </button>
    {% endif %}

    <nav id="page-container">
      <ul id="page-links" class="pagination">
        <li class="disabled"><a href="" aria-label="Previous"><span aria-hidden="true">«</span></a></li>
        <li class="hidden"><a href="">1</a></li>
        <li class="hidden"><a href="#"><span aria-hidden="true">…</span></a></li>
        <li class="hidden"><a href="#"></a></li>
        <li class="hidden"><a href="#"></a></li>
        <li class="active this-page"><a href="#"></a></li>
        <li class="hidden"><a href="#"></a></li>
        <li class="hidden"><a href=""></a></li>
        <li class="hidden"><a href="#"><span aria-hidden="true">…</span></a></li>
        <li class="hidden"><a href=""></a></li>
        <li class="disabled"><a href="#" aria-label="Next"><span aria-hidden="true">»</span></a></li>
      </ul>
    </nav>
    {% endblock request_forms %}
    </div>

    <div id="request-info" class="request-info" style="clear: both" aria-label="{% trans "request info" %}">
      <pre ><b>{{ request.method }}</b> {{ request.get_full_path }}</pre>
    </div>

    <div class="response-info" aria-label="{% trans "response info" %}">
      <pre ><span class="meta nocode"><span id="response-headers"></span></span> 
<span id="response-content">Retrieving data...</span></pre>
    </div>
  </div>

  {% if display_edit_forms %}
    {% if post_form or raw_data_post_form %}
      <div {% if post_form %}class="tabbable"{% endif %}>
        {% if post_form %}
          <ul class="nav nav-tabs form-switcher">
            <li>
              <a name='html-tab' href="#post-object-form" data-toggle="tab">HTML form</a>
            </li>
            <li>
              <a name='raw-tab' href="#post-generic-content-form" data-toggle="tab">Raw data</a>
            </li>
          </ul>
        {% endif %}

        <div class="well tab-content">
          {% if post_form %}
            <div class="tab-pane" id="post-object-form">
              {% with form=post_form %}
                <form action="{{ request.get_full_path }}" method="POST" enctype="multipart/form-data" class="form-horizontal" novalidate>
                  <fieldset>
                    {% csrf_token %}
                    {{ post_form }}
                    <div class="form-actions">
                      <button class="btn btn-primary js-tooltip" title="Make a POST request on the {{ name }} resource">POST</button>
                    </div>
                  </fieldset>
                </form>
              {% endwith %}
            </div>
          {% endif %}

          <div {% if post_form %}class="tab-pane"{% endif %} id="post-generic-content-form">
            {% with form=raw_data_post_form %}
              <form action="{{ request.get_full_path }}" method="POST" class="form-horizontal">
                <fieldset>
                  {% include "rest_framework/raw_data_form.html" %}
                  <div class="form-actions">
                    <button class="btn btn-primary js-tooltip" title="Make a POST request on the {{ name }} resource">POST</button>
                  </div>
                </fieldset>
              </form>
            {% endwith %}
          </div>
        </div>
      </div>
    {% endif %}

    {% if put_form or raw_data_put_form or raw_data_patch_form %}
      <div {% if put_form %}class="tabbable"{% endif %}>
        {% if put_form %}
          <ul class="nav nav-tabs form-switcher">
            <li>
              <a name='html-tab' href="#put-object-form" data-toggle="tab">HTML form</a>
            </li>
            <li>
              <a  name='raw-tab' href="#put-generic-content-form" data-toggle="tab">Raw data</a>
            </li>
          </ul>
        {% endif %}

        <div class="well tab-content">
          {% if put_form %}
            <div class="tab-pane" id="put-object-form">
              <form action="{{ request.get_full_path }}" data-method="PUT" enctype="multipart/form-data" class="form-horizontal" novalidate>
                <fieldset>
                  {{ put_form }}
                  <div class="form-actions">
                    <button class="btn btn-primary js-tooltip" title="Make a PUT request on the {{ name }} resource">PUT</button>
                  </div>
                </fieldset>
              </form>
            </div>
          {% endif %}

          <div {% if put_form %}class="tab-pane"{% endif %} id="put-generic-content-form">
            {% with form=raw_data_put_or_patch_form %}
              <form action="{{ request.get_full_path }}" data-method="PUT" class="form-horizontal">
                <fieldset>
                  {% include "rest_framework/raw_data_form.html" %}
                  <div class="form-actions">
                    {% if raw_data_put_form %}
                      <button class="btn btn-primary js-tooltip" title="Make a PUT request on the {{ name }} resource">PUT</button>
                    {% endif %}
                    {% if raw_data_patch_form %}
                    <button data-method="PATCH" class="btn btn-primary js-tooltip" title="Make a PATCH request on the {{ name }} resource">PATCH</button>
                      {% endif %}
                  </div>
                </fieldset>
              </form>
            {% endwith %}
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}
{% endblock content %}

{% block script %}
<div id="datalists">
  <datalist id="query-parameter-options"></datalist>
  <datalist id="header-parameter-options">
    <option value="Accept">Accept</option>

  </datalist>
  <datalist id="boolean">
    <option value="true">true</option>
    <option value="false">false</option>
  </datalist>
</div>
<script>
  window.drf = {
    csrfHeaderName: "{{ csrf_header_name|default:'X-CSRFToken' }}",
    csrfToken: "{% if request %}{{ csrf_token }}{% endif %}"
  };
</script>
<script>
  var PAGEURL = new URL(window.location.href);
  var isPaginated = false;

  const HEADERS = [ "Allow", "Content-Type","Content-Crs", "Vary", "X-Pagination-Limit", "X-Pagination-Page" , "X-Total-Count", "X-Pagination-Count"]
  // Headers that should be set on page load. (without this the api would return html)
  const DEFAULT_HEADERS = {Accept:"*/*"}
  const OPERATORS = {
    eq:"=",
    gt:">",
    gte:">=",
    lt: "<",
    lte: "<=",
    "in":"in", 
    not: "!=",
  }
  const PAGELINKS = {
    PREVIOUS:0,
    ONE:1,
    BACK3:2,
    BACK2:3,
    BACK1:4,
    SELF:5,
    FORWARD1: 6,
    FORWARD2: 7,
    FORWARD3: 8,
    LAST: 9,
    NEXT:10,
  }
  // max number of extra pagination links shown
  const NUM_EXTRA_PAGES = 4
  // Default parameters that are not listed in open api spec
  const DEFAULT_PARAMS = {
    "Accept": {
      name: "Accept", 
      in: "header", 
      description: "",
      examples: {
          any: {value:"*/*", description:"accept any", summary: "Any"},
          hal_json: {value:"application/hal+json", description:"accept HAL JSON", summary: "HAL JSON"},
      },
      operators:[
        {name:"eq", in: "header", 
        examples: {
          any: {value:"*/*", description:"accept any", summary: "Any"},
          hal_json: {value:"application/hal+json", description:"accept HAL JSON", summary: "HAL JSON"},
      },
        schema:{type:"string"}}
      ], 
      schema:{type:"string"}
    },
    "Authorization": {
      name: "Authorization", 
      in: "header", 
      description: "",
      examples: {
          any: {value:"Bearer ey...", description:"bearer token", summary: "bearer token"},
      },
      operators:[
        {name:"eq", in: "header", 
        examples: {
          any: {value:"Bearer ey...", description:"bearer token", summary: "bearer token"},
      },
        schema:{type:"string"}}
      ], 
      schema:{type:"string"}
    }
  }
  const CLIENTID = "dso-api-open-api"
  const REDIRECTURI = PAGEURL.origin + "/v1/oauth2-redirect.html"

  // Hack into swagger auth state
  var swaggerUIRedirectOauth2 = {
    state: null,
    redirectUrl: REDIRECTURI,
    auth: {schema: {get:(t) => {return "implicit"}}, code:null},
    errCb: err => console.log("err callback", err),
    callback: authorizationResult => {
      let headersEl = document.getElementById("request-headers");
      let token = authorizationResult.token;
      window.localStorage.setItem("authToken", JSON.stringify(token)) 
      addSetting("Authorization","Bearer " + token.access_token, true)
      showHeaders()
    }
  }
  var dsoShowToken = token => {}

  // Open API variables
  var oaParams = null;
  var oaSpec = null;

  if (document.readyState != 'loading') {
    onPageLoad();
  }
  if(document.addEventListener) {
      document.addEventListener("DOMContentLoaded", onPageLoad);
  }

  function setURL(url) {
    PAGEURL = new URL(decodeURI(url));
    for (let paramkey of PAGEURL.searchParams.keys()) {
      let value = PAGEURL.searchParams.get(paramkey);
      let [key, operator] = splitKeyandOperator(paramkey)
      updateSetting(key, value, operator, type="param") 
    }

  }

  window.onpopstate = function(e){
    if(e.state){
      setURL(e.state.url)
      setParams(e.state.params)
      console.log("state", JSON.parse(JSON.stringify(e.state)))
      updatePageRequest(e.state.url, e.state.method, false, e.state.headers )
    }
  };

  function onPageLoad() {
    let page = PAGEURL.searchParams.get("page");
    setURL(PAGEURL.href)
    setParams()
    setHeaders()
    setPageLinks(page);

    getData(PAGEURL).catch(parseException).then(data => {
      if(data) {
        parseData(data);
      }
      window.history.replaceState(JSON.parse(JSON.stringify({"url":PAGEURL, "method":"get", "params": getRequestSettings(), "headers": getRequestSettings("headers")})), "", PAGEURL)
    });

    getOpenApi((params) => {
      oaParams = params;
      setParams();
      setHeaders()
      document.getElementById("authorize-btn").classList.remove("disabled");
    })
    // Override the default DRF behaviour of the OPTIONS, and GET buttons,
    // which do not work with our script.
    // We make the request and replace the page content with the response.
    document.getElementById("options-button").onclick = e => {
      updatePageRequest(PAGEURL, "OPTIONS")
      e.preventDefault();
    }
    document.getElementById("get-button").onclick = e => {
      updatePageRequest(getUrlFromSettings())
      e.preventDefault();
    }

    for (let optEl of document.getElementsByClassName("format-option")) {
      optEl.onclick = e => {
        let formatValue = e.target.innerHTML
        url = getUrlFromSettings()
        url.searchParams.set("_format", formatValue)
        updateSetting(Accept, "*/*")
        updatePageRequest(url,"GET", true)
        e.preventDefault();
      }
    }
  }

  function updatePageRequest(url, method="GET", pushHistory=true, headerSettings=null) {
    // Make a request to the api and update the page with the response
    setURL(url);
    
    if (headerSettings == null) {
      headerSettings = getRequestSettings("headers");
    }

    console.log("headerSettings", headerSettings)
    headers = {}
    headerSettings.forEach(h => {
      if(h.active) {
        headers[h.key] = h.value;
      }
    })

    let reqInfoEl = document.getElementById("request-info")
    reqInfoEl.innerHTML = `<pre ><b>${method}</b> ${PAGEURL}</pre>`
    document.getElementById("response-content").innerHTML = "Retrieving data..."
    let page = PAGEURL.searchParams.get("page");
    setPageLinks(page);
    getData(url, method, headers).catch(parseException).then(data => {
      if (pushHistory) {
        window.history.pushState(JSON.parse(JSON.stringify({"url":url, "method":method, "params": getRequestSettings("params"), "headers":headerSettings})),"", url);
      }
      if(data) {
          parseData(data)
      }
      setParams();
      setHeaders(headerSettings)
    });
  }

  function authorize() {
    if(!oaSpec) {
      return
    }
    authUrl = new URL(oaSpec.components.securitySchemes.oauth2.flows.implicit.authorizationUrl)

    authUrl.searchParams.set("client_id", CLIENTID);
    authUrl.searchParams.set("redirect_uri", REDIRECTURI);
    authUrl.searchParams.set("response_type", "token");
    window.open(authUrl, '_blank')
  } 

  function getRequestSettings(type="params") {
    // Get query parameter or header request settings from the form.
    if (type == null) {
      return getRequestSettings("params").concat("headers")
    } 
    let paramsEl = document.getElementById("request-" + type);
    return [...Array(paramsEl.childElementCount).keys()].map(
        i => {
          let paramEl = paramsEl.children.item(i);
          let key = paramEl.getElementsByClassName("param-key")[0].value;
          let operator = paramEl.getElementsByClassName("param-op")[0].value;
          let combinedKey = key;
          if (operator != "eq") {
            combinedKey += `[${operator}]`;
          }
    
          return {
            active: paramEl.getElementsByClassName("param-check")[0].checked,
            key: key,
            combinedKey: combinedKey,
            operator: operator,
            value: paramEl.getElementsByClassName("param-val")[0].value,
            element: paramEl
          }
      }).filter(x => x.key != "")
  }

  function getUrlFromSettings() {
    // Get the URL of this endpoint with new request parameter settings
    let url = new URL(PAGEURL);
    url.search = "";
    getRequestSettings().forEach(param => {
      if (param.active && param.key != "") {
        url.searchParams.set(param.combinedKey, param.value);
      }
    })
    return url;
  };

  function getPageUrl(page) {
    // Get the URL of another page of this endpoint
    let url = new URL(PAGEURL);
    url.searchParams.set("page", page);
    return url;
  };

  function setPageLinks(page) {
    // Set the pagination links with the correct values for this page
    page = Number(page);

    let pageLinksEl = document.getElementById("page-links");
    pageLinksEl.innerHTML = `
          <li class="disabled"><a href="" aria-label="Previous"><span aria-hidden="true">«</span></a></li>
          <li class="hidden"><a href="">1</a></li>
          <li class="hidden"><a href="#"><span aria-hidden="true">…</span></a></li>
          <li class="hidden"><a href="#"></a></li>
          <li class="hidden"><a href="#"></a></li>
          <li class="active this-page"><a href="#"></a></li>
          <li class="hidden"><a href="#"></a></li>
          <li class="hidden"><a href=""></a></li>
          <li class="hidden"><a href="#"><span aria-hidden="true">…</span></a></li>
          <li class="hidden"><a href=""></a></li>
          <li class="disabled"><a href="#" aria-label="Next"><span aria-hidden="true">»</span></a></li>
    `

    if(isNaN(page) || page<1){
      isPaginated = false;
      return
    }
    isPaginated = true;

    let links = pageLinksEl.getElementsByTagName("li");
    links = [...Array(links.length).keys()].map(
      i => {
      return {
        "li":links.item(i), 
        "a": links.item(i).getElementsByTagName("a")[0]
      }
    })
    
    // Set forward page links, but leave disabled for now.
    links[PAGELINKS.NEXT]["a"].setAttribute("href", getPageUrl(page+1));
    links[PAGELINKS.FORWARD1]["a"].setAttribute("href", getPageUrl(page+1));
    links[PAGELINKS.FORWARD1]["a"].innerHTML = page + 1
    links[PAGELINKS.FORWARD2]["a"].setAttribute("href", getPageUrl(page+2));
    links[PAGELINKS.FORWARD2]["a"].innerHTML = page + 2
    links[PAGELINKS.FORWARD3]["a"].setAttribute("href", getPageUrl(page+3));
    links[PAGELINKS.FORWARD3]["a"].innerHTML = page + 3
    links[PAGELINKS.LAST]["a"].setAttribute("href", getPageUrl(page+4));
    links[PAGELINKS.LAST]["a"].innerHTML = page + 4

    links.forEach(link => {
      link["a"].onclick = e => {
        updatePageRequest(e.target.href)
        e.preventDefault();
      }
    })

    // Set self and previous links
    for (let i = 0; page-i && i<NUM_EXTRA_PAGES; i++) {
      let el = links[PAGELINKS.SELF-i];
      el["a"].setAttribute("href", getPageUrl(page-i));
      el["a"].innerHTML = page-i;
      el["li"].classList.remove("hidden");
    }
    
    if(page > 1) {
      // Set previous link
      links[PAGELINKS.PREVIOUS]["a"].setAttribute("href", getPageUrl(page-1));
      links[PAGELINKS.PREVIOUS]["li"].classList.remove("disabled");

      if(page > 4) {
        // Set page 1 link
        links[PAGELINKS.ONE]["a"].setAttribute("href", getPageUrl(1));
        links[PAGELINKS.ONE]["li"].classList.remove("hidden");
      }
      if(page > 5){
        // Set ... link
        links[PAGELINKS.BACK3]["a"].innerHTML = "...";
        links[PAGELINKS.BACK3]["li"].classList.add("disabled");
      }
    }
    // Show the links
    let containerEl = document.getElementById("page-container");
    containerEl.classList.add("active");
  }

  function getData(url, method="GET", headers=DEFAULT_HEADERS, doParseHeaders=true) {
    return new Promise(function(callback, err) {
      let http = new XMLHttpRequest();
      http.open(method, url, true);
      for (let k in headers) {
        http.setRequestHeader(k, headers[k]);
      }
      
      http.send();
      http.onreadystatechange = function () {
        if (this.readyState === 2 && doParseHeaders){
          parseResponseHeaders(this);
        }
        if (this.readyState === 4){
          try {
            let result = JSON.parse(this.responseText);
            callback(result);
          } catch (error) {
            err([error, this.responseText]);
          }
        }
      }; 
    }); 
  }

  function showHeaders() {
    document.getElementById("headers-tab").dispatchEvent(new Event('click'))
  }

  function addSetting(key, value, active=true, op="eq", type="header") {
    // Add new header and deactivate any existing header
    let requestSettings = getRequestSettings(type + "s");
    let sameSetting = requestSettings.find(x => x.key == key && x.operator == op && x.value == value);
    if (sameSetting) {
      sameSetting.element.getElementsByClassName("param-check")[0].checked = active;
      sameSetting.element.getElementsByClassName("param-check")[0].dispatchEvent(new Event('change'));
      return
    }
    requestSettings.filter(x => x.key == key && x.operator == op  && x.active).forEach(setting => {
      setting.element.getElementsByClassName("param-check")[0].checked = false;
      setting.element.getElementsByClassName("param-check")[0].dispatchEvent(new Event('change'));
    })
    pushSetting(key, value, active, op, type)
  }

  function updateSetting(key, value, op="eq", type="header") {
    console.log("update",key,value,op)
    // Update value of existing header or add new header if it does not exist
    let requestSettings = getRequestSettings(type +"s");
    console.log(requestSettings)
    let setting = requestSettings.find(x =>  x.key == key && x.operator == op  && x.active)
    if(setting) {
      setting.element.getElementsByClassName("param-val")[0].value = value
    } else {
      pushSetting(key, value, true, op, type)
    }
  }

  function pushSetting(key, val, active, op="eq", type="header") {
    let paramsEl = document.getElementById("request-" + type + "s");
    let lastChild = paramsEl.lastElementChild;
    let newParam = createParamEl(key, val, op, active, type);
    if(lastChild) {
      paramsEl.replaceChild(newParam, paramsEl.lastElementChild)
      paramsEl.appendChild(lastChild)
    } else {
      paramsEl.appendChild(newParam)
      paramsEl.appendChild(createParamEl(null, null,"eq", true, type))
    }
    
    
  }

  function escapeString(string) {
    let element = document.createElement('div');
    element.innerHTML = string;
    return element.innerHTML;
  }

  function parseResponseHeaders(response) {
    // Set header fields
    let headersElement = document.getElementById("response-headers");
    headersElement.innerHTML = `<b>HTTP ${response.status} ${response.statusText}</b>\n`;
    
    for(let header of HEADERS) {
      let headerValue = response.getResponseHeader(header);
      if (headerValue){
        let headerline = `<b>${header}:</b> <span class="lit">${escapeString(headerValue)}</span>\n`;
        headersElement.innerHTML += headerline;
      }
    }
    
    // Remove page links if no pagination (for error pages)
    let page = response.getResponseHeader("X-Pagination-Page");
    if (!page) {
      document.getElementById("page-container").classList.remove("active");                                   
    } else if (!isPaginated) {
      // If paginated but pagination has not yet been set (for page 1)
      setPageLinks(page);
    }
  }

  function parseException(err) {
    let exception = err[0], responseText = err[1];  // promises only allow 1 argument.
    console.error("Failed to retrieve JSON API response from server:", exception);

    let contentElement = document.getElementById("response-content");
    contentElement.innerHTML = responseText.replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
  }

  function parseData(data) {
    let contentElement = document.getElementById("response-content");

    // We need to mark coordinates fields so we can make them collapsible.
    let markCoordinates = (key, value) => {
        if (key == "coordinates"){
            return "__coordinatestring__" + JSON.stringify(value, null, 4);
        }
        return value;
    }
    
    // Activate next links
    let containerEl = document.getElementById("page-container");
    if(data["_links"] && data["_links"]['next']) {
      let links = document.getElementById("page-links").getElementsByTagName("li")
      links = [...Array(links.length).keys()].map(
        i => {
        return {
          "li":links.item(i), 
          "a": links.item(i).getElementsByTagName("a")[0]
        }
      })
      links[PAGELINKS.NEXT]["li"].classList.remove("disabled");
      links[PAGELINKS.FORWARD1]["li"].classList.remove("hidden");

      // If the count is known (because user explicitly requested),
      // we can show a bit more information
      if(data["page"] && data["page"]['totalPages']) {
        const numPages = data["page"]["totalPages"]
        const available = numPages - data["page"]["number"]
        if (available > NUM_EXTRA_PAGES) {
          links[PAGELINKS.LAST]["a"].setAttribute("href", getPageUrl(numPages));
          links[PAGELINKS.LAST]["a"].innerHTML = numPages
          links[PAGELINKS.FORWARD3]["a"].innerHTML = "..."
          links[PAGELINKS.FORWARD3]["li"].classList.add("disabled");
        }

        for (var i = 1; i < NUM_EXTRA_PAGES && i < available; i++) {
          links[PAGELINKS.FORWARD1 + i]["li"].classList.remove("hidden")
        }
      }
      containerEl.classList.add("active");
    } else if(data["_links"] && data["_links"]['previous']) {
      containerEl.classList.add("active");
    } else {containerEl.classList.remove("active");}

    // Create highlighted html string and set content
    let jsonString = JSON.stringify(data, markCoordinates, 4);
    contentElement.innerHTML = syntaxHighlight(jsonString);
  }

  function syntaxHighlight(jsonString) {
      // Escape HTML but leave quotemarks in place.
      jsonString = escapeString(jsonString);
      return jsonString.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
          let cls = 'number';
          if (/^"https?:\/\//.test(match)) {
              // Create a link for strings containing an url.
              let uri = match.substring(1,match.length-1)
              return `<a href="${uri}" rel="nofollow"><span class="link">${match}</span></a>`;
          }
          if (/^"__coordinatestring__/.test(match)) {
              // Cut the marker and enclosing quotes from the coordinates string and unescape newlines.
              match = match.substring(21,match.length-1).replace(/\\n/g, "\n");

              // Grab the head and tail for the summary and remove whitespace.
              let head = match.substring(0,100).replace(/\n| /g, "");
              let tail = match.substring(match.length-100).replace(/\n| /g, "");

              // If coordinates don't describe a point.
              // Show a summary that can be expanded with a click.
              if(/^\[\[/.test(head)) {
                let result = `<span class="collapsible collapsed" onClick="this.classList.toggle(\'collapsed\')">`;
                result += `<span class="collapsible_summary">${syntaxHighlight(head)} ... ${syntaxHighlight(tail)}</span>`;
                result += `<span class="collapsible_content">${syntaxHighlight(match)}</span></span>`;
                return result;
              } else {
                match = match.replace(/\n\s*/g, " ");
              } 
          }
          if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                  cls = 'key';
              } else {
                  cls = 'string';
              }
          } else if (/true|false/.test(match)) {
              cls = 'bool';
          } else if (/null/.test(match)) {
              cls = 'null';
          }
          return `<span class="${cls}">${match}</span>`;
      });
  }

  function splitKeyandOperator(value) {
    let key = value.split("[")[0]
    let op = "eq"
    if (key != value) {
      op = value.split("[")[1].split("]")[0]
    }
    return [key, op]
  }

  function addParamEnumDatalist(param, name=null) {
    if (param.schema.enum) {
      let datalistsEl = document.getElementById("datalists");
      let datalistEl = document.createElement("datalist");
      datalistEl.id = `datalist-${name || param.name}-enum`
      for (item of param.schema.enum) {
          let option = document.createElement("option");
          option.value = item;
          option.text = item;
          datalistEl.appendChild(option);
      }
      datalistsEl.appendChild(datalistEl);
    }
  }

  function addParamExampleDatalist(param, name=null) {
    if (param.examples) {
      let datalistsEl = document.getElementById("datalists");
      let datalistEl = document.createElement("datalist");
      datalistEl.id = `datalist-${name || param.name}-examples`
      for (k in param.examples) {
          let option = document.createElement("option");
          option.value = param.examples[k].value;
          option.text = param.examples[k].value;
          option.title = param.examples[k].description;
          datalistEl.appendChild(option);
      }
      datalistsEl.appendChild(datalistEl);
    }
  }

  function getOpenApi(callback) {
    let oaURL = new URL(PAGEURL)
    let params = JSON.parse(JSON.stringify(DEFAULT_PARAMS))
    // Add Default headers.
    for (k in params) {
      addParamEnumDatalist(params[k], params[k].name+"[eq]")
      addParamExampleDatalist(params[k], params[k].name+"[eq]")
    }

    if (!"{{ dataset_url }}") {
      return callback(params)
    }
    oaURL.pathname = "{{ dataset_url }}"
    oaURL.search = "?format=json";
    return getData(oaURL.href, "GET", {Accept:"*/*"}, false).then(oaJSON => 
    {
      oaJSON.paths[PAGEURL.pathname].get.parameters.filter(a => !a.name.includes("[")).forEach(x => {
        addParamEnumDatalist(x, x.name+"[eq]")
        addParamExampleDatalist(x, x.name+"[eq]")
        name = x.name
        param = JSON.parse(JSON.stringify(x))
        equalOp = JSON.parse(JSON.stringify(x))
        equalOp.name = "eq"
        param.operators = [equalOp];
        params[name] = param;
      })
      oaJSON.paths[PAGEURL.pathname].get.parameters.filter(a => a.name.includes("[")).forEach(x => {
        addParamEnumDatalist(x)
        addParamExampleDatalist(x)
        let param = JSON.parse(JSON.stringify(x))
        let [key, op] = splitKeyandOperator(x.name)
        param.name= op; 
        params[key].operators.push(param)
      })   

      // Add each parameter to the datalist
      for (inside of ["query", "header"]) {
        let paramDatalistEl = document.getElementById(inside +"-parameter-options");
        paramDatalistEl.innerHTML = ""
        for (const param in params) {
          if(params[param].in === inside){
            let option = document.createElement("option");
            option.value = param;
            option.text = param;
            option.title = params[param].description
            paramDatalistEl.appendChild(option);
          }
        } 
      }
      oaSpec = oaJSON;
      return callback(params);
    })
  }

  function onParamKeySet(event) {
    if (oaParams == null) {
      return
    }

    let [key, selectedOp] = splitKeyandOperator(event.target.value)
    if (oaParams.hasOwnProperty(key)) {
      param = oaParams[key]
      event.target.title = param.description
      event.target.setCustomValidity("");

      opEl = event.target.parentElement.getElementsByClassName("param-op")[0];

      // Use operator from key field before value in operator field
      if(selectedOp == "eq") {
        selectedOp = opEl.value
      } 
      opEl.innerHTML = "";
      opEl.dataset.key = key
      param.operators.forEach(operator => {
        let option = document.createElement("option");
        option.value = operator.name;
        option.text = OPERATORS[operator.name] || operator.name;
        option.title = operator.description
        if (operator.name === selectedOp) {
            option.setAttribute("selected", "selected");
            event.target.value = key
          }
          opEl.appendChild(option);
      })
      opEl.dispatchEvent(new Event('change'));
      

    } else {
      event.target.title = "onbekende parameter"
      event.target.setCustomValidity("onbekende parameter");
    }
    event.target.parentElement.dispatchEvent(new Event("mouseenter"))
    if(!event.target.parentElement.nextElementSibling && event.target.parentElement.parentElement ) {
        event.target.parentElement.parentElement.appendChild(createParamEl(null, null,"eq", true, param.in));
    }
  }

  function parseJwt (token) {
    let base64Url = token.split('.')[1];
    let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
};

  function onParamOpSet(event) {
    key = event.target.dataset.key;
    op = event.target.value;
    if (oaParams.hasOwnProperty(key)) {
      param = oaParams[key]
      opParam = param.operators.find(x => x.name == event.target.value)
      event.target.title = opParam.description
      oldValueEl = event.target.parentElement.getElementsByClassName("param-val")[0];
      valueEl = document.createElement("input")
      valueEl.value = oldValueEl.value
      valueEl.placeholder = oldValueEl.placeholder
      valueEl.className = oldValueEl.className
      let type = opParam.schema.format || opParam.schema.type ||param.schema.format || param.schema.type;
      if (opParam.schema.enum) {
        valueEl.setAttribute("list", `datalist-${key}[${op}]-enum`);
      }
      if (opParam.examples) {
        valueEl.setAttribute("list", `datalist-${key}[${op}]-examples`);
      }
      if (type == "date-time") {
        valueEl.type = "datetime-local"
      }
      else if (type == "date") {
        valueEl.type = "date"
      }
      else if (type == "integer") {
        valueEl.type = "number";
        valueEl.step = 1;
      }
      else if (type == "boolean") {
        valueEl.setAttribute("list", "boolean");
      }
      oldValueEl.parentNode.replaceChild(valueEl, oldValueEl);
    }
  }

  function createParamEl(key=null, value=null, op="eq", active=true, insideOf="query") {
    let paramEl = document.createElement('div');
    paramEl.className = "param";
    let activeEl = document.createElement('input');
    activeEl.type = "checkbox"
    activeEl.className = "param-check"
    activeEl.checked = active
    activeEl.onchange = (e) => {e.target.checked? e.target.parentElement.classList.remove("disabled"): e.target.parentElement.classList.add("disabled")}
    paramEl.appendChild(activeEl);
    activeEl.dispatchEvent(new Event('change'))

    let keyEl = document.createElement('input');
    keyEl.className = "param-key";
    keyEl.setAttribute("list", insideOf +"-parameter-options");
    keyEl.placeholder = "select a parameter";
    keyEl.autocomplete = "off"
    keyEl.addEventListener('change', onParamKeySet)
    keyEl.onmouseover = (e) => {e.target.dispatchEvent(new Event('focus'));e.target.dataset.old=e.target.value;}
    keyEl.onmousedown = (e) => {if(oaParams!=null&& !(e.target.value in oaParams)){e.target.value ="";}}
    keyEl.onmouseup = (e) => {e.target.value =e.target.dataset.old;}
    keyEl.onblur = (e) => {if(e.target.value==""){e.target.value =e.target.dataset.old;}}
    paramEl.appendChild(keyEl);
    
    let opEl = document.createElement('select');
    opEl.className = "param-op";
    opEl.innerHTML = `<option value="${op}" selected>${OPERATORS[op] || op}</option>`
    opEl.addEventListener('change', onParamOpSet)
    paramEl.appendChild(opEl);
    
    let valueEl = document.createElement('input');
    valueEl.className = "param-val";
    valueEl.placeholder = "enter a value"
    valueEl.value = value
    paramEl.appendChild(valueEl);
    
    let deleteEl = document.createElement('button');
    deleteEl.className = "remove-param-btn btn glyphicon glyphicon-trash"
    deleteEl.onclick = (e) => {e.target.parentElement.remove()}
    paramEl.appendChild(deleteEl);

    let infoEl = document.createElement('div');
    infoEl.className = "param-info hidden"
    infoEl.onclick = e => {e.target.classList.toggle("expand")}
    paramEl.appendChild(infoEl);
    paramEl.onmouseenter = e => setInfoBubble(e.target)

    if (oaParams == null) {
      paramEl.classList.add("loading")
    }
    if (key != null) {
      keyEl.value = key;
      let event = new Event('change');
      keyEl.dispatchEvent(event);
    }
    return paramEl
  }

  function setInfoBubble(element){
    let valueEl = element.getElementsByClassName("param-val")[0];
    let infoEl = element.getElementsByClassName("param-info")[0];
    if(valueEl && valueEl.value.startsWith("Bearer ")) {
      let token = parseJwt(valueEl.value)
      let isExpired = token.exp*1000 < (new Date()).getTime();
      let minutesRemaining = Math.floor((new Date(token.exp*1000) - new Date()) / 60000)
      expiredText = `Exp:${minutesRemaining}min`
      summary = `${token.preferred_username} ${isExpired?"Expired":expiredText} `
      infoEl.innerHTML =  `<div class="summary">${summary}</div><pre>${syntaxHighlight(JSON.stringify(token,null,4))}</pre>`
      infoEl.classList.remove("hidden");
    } else {
      infoEl.classList.add("hidden");
    }
  }

  function setHeaders(headers=null) {
    console.log("headers", headers)
    let headersEl = document.getElementById("request-headers");
    headersEl.innerHTML = ""
    if (headers) {
      headers.forEach(header => {
        headersEl.appendChild(createParamEl(header.key, header.value, "eq", header.active, "header"));
      })
    }
    else {
      for (key in DEFAULT_HEADERS) {
        headersEl.appendChild(createParamEl(key, DEFAULT_HEADERS[key], "eq", true, "header"));
      }
      let token = JSON.parse(window.localStorage.getItem("authToken"))
      if (token) {
        addSetting("Authorization", "Bearer " + token.access_token, false, "eq", "header")
      }
    }
    
    headersEl.appendChild(createParamEl(null,null,"eq", true, "header"))
  }

  function setParams(params=null) {
    let paramsEl = document.getElementById("request-params");
    paramsEl.appendChild(createParamEl())
    console.log("params", params)
    if(params == null) {
      for (let paramkey of PAGEURL.searchParams.keys()) {
        let value = PAGEURL.searchParams.get(paramkey);
        let [key, operator] = splitKeyandOperator(paramkey)
        updateSetting(key, value, operator, type="param") 
      }
      params = getRequestSettings();
    }

    paramsEl.innerHTML = ""
    params.forEach(param => {
      let active = PAGEURL.searchParams.has(param.combinedKey) || param.key=="";
      console.log("set param",param.key, param.value, param.operator, active)
      paramsEl.appendChild(createParamEl(param.key, param.value, param.operator, active));
    })

    paramsEl.appendChild(createParamEl())
  }

</script>
<script src="{% static "rest_framework/js/jquery-3.5.1.min.js" %}"></script>
<script src="{% static "rest_framework/js/ajax-form.js" %}"></script>
<script src="{% static "rest_framework/js/csrf.js" %}"></script>
<script src="{% static "rest_framework/js/bootstrap.min.js" %}"></script>
<script>
  $(document).ready(function() {
    $('form').ajaxForm();
  });
</script>
{% endblock %}

{% block bootstrap_navbar_variant %}{% endblock %}
